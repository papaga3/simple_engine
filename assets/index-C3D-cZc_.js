var v=Object.defineProperty;var E=(s,t,e)=>t in s?v(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var i=(s,t,e)=>E(s,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function e(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(r){if(r.ep)return;r.ep=!0;const a=e(r);fetch(r.href,a)}})();const U=8,I=320,R=180;class F{constructor(){i(this,"callbacks",[]);i(this,"nextID",0);i(this,"on",(t,e,n)=>(this.nextID+=1,this.callbacks.push({id:this.nextID,eventName:t,caller:e,callback:n}),this.nextID));i(this,"off",t=>{this.callbacks=this.callbacks.filter(e=>e.id!==t)})}emit(t,e){this.callbacks.forEach(n=>{n.eventName===t&&n.callback(e)})}unsunscribe(t){this.callbacks=this.callbacks.filter(e=>e.caller!==t)}}const w=new F;class c{constructor(t,e){i(this,"x");i(this,"y");i(this,"duplicate",()=>new c(this.x,this.y));this.x=t,this.y=e}}class g{constructor(t){i(this,"position");i(this,"children");i(this,"drawOffSet");i(this,"parent");i(this,"stepEntry",(t,e)=>{this.children.forEach(n=>n.stepEntry(t,e)),this.step(t,e)});i(this,"draw",(t,e,n)=>{const r=e+this.position.x+this.drawOffSet.x,a=n+this.position.y+this.drawOffSet.y;this.drawImage(t,r,a),this.children.forEach(o=>o.draw(t,r,a))});i(this,"destroy",()=>{this.children.forEach(t=>{t.destroy()}),this.parent!==null&&this.parent.removeChild(this)});this.drawOffSet=t.drawOffSet??new c(0,0),this.position=t.position??new c(0,0),this.parent=t.parent??null,this.children=[]}addChild(t){this.children.push(t)}removeChild(t){w.unsunscribe(t),this.children=this.children.filter(e=>t!==e)}}class C extends g{constructor(t){super(t)}step(){}drawImage(){}}class D extends g{step(){}drawImage(){}constructor(){super({}),w.on("HERO_POSITION",this,t=>{const e=I/2-U,n=R/2-U;this.position=new c(e-t.x,n-t.y)})}}class K{constructor(t,e){i(this,"lastTimeFrame");i(this,"accumulatedTime");i(this,"timeStep");i(this,"update");i(this,"render");i(this,"rafId");i(this,"isRunning");i(this,"mainLoop",t=>{if(!this.isRunning)return;let e=t-this.lastTimeFrame;this.lastTimeFrame=t,this.accumulatedTime+=e,this.accumulatedTime>=this.timeStep&&(this.update(this.timeStep),this.accumulatedTime=0),this.render(),this.rafId=requestAnimationFrame(this.mainLoop)});i(this,"start",()=>{this.isRunning||(this.isRunning=!0),this.rafId=requestAnimationFrame(this.mainLoop)});i(this,"stop",()=>{this.rafId&&cancelAnimationFrame(this.rafId),this.isRunning=!1});this.lastTimeFrame=0,this.accumulatedTime=0,this.timeStep=1e3/60,this.update=t,this.render=e,this.rafId=null,this.isRunning=!1}}const P=s=>s*16,_=(s,t,e)=>{const n=`${t},${e}`;return!s.has(n)},l=new Set;l.add("64,48");l.add("64,64");l.add("64,80");l.add("80,64");l.add("80,80");l.add("112,80");l.add("128,80");l.add("144,80");l.add("160,80");class N{constructor(t){i(this,"patterns");i(this,"activeKey");i(this,"step",t=>{this.patterns[this.activeKey].step(t)});i(this,"play",(t,e=0)=>{this.activeKey!==t&&(this.activeKey=t,this.patterns[this.activeKey].currentTime=e)});i(this,"frame",()=>this.patterns[this.activeKey].frame());this.patterns=t,this.activeKey=Object.keys(this.patterns)[0]}}class p{constructor(t){i(this,"animationConfig");i(this,"currentTime");i(this,"duration");i(this,"step",t=>{this.currentTime+=t,this.currentTime>=this.duration&&(this.currentTime=0)});i(this,"frame",()=>{const{frames:t}=this.animationConfig;for(let e=t.length-1;e>=0;e--)if(this.currentTime>=t[e].time)return t[e].frame;throw"Time is before the first keyframe"});this.currentTime=0,this.animationConfig=t,this.duration=t.duration??500}}const H=(s,t,e)=>{let n=t.x-s.position.x,r=t.y-s.position.y,a=Math.sqrt(n**2+r**2);if(a<=e)s.position.x=t.x,s.position.y=t.y;else{const o=n/a,h=r/a;s.position.x+=o*e,s.position.y+=h*e,n=t.x-s.position.x,r=t.y-s.position.y,a=Math.sqrt(n**2+r**2)}return a};var d=(s=>(s[s.UP=0]="UP",s[s.DOWN=1]="DOWN",s[s.LEFT=2]="LEFT",s[s.RIGHT=3]="RIGHT",s[s.ERROR=-1]="ERROR",s))(d||{});class W{constructor(){i(this,"heldDirections");i(this,"onArrowPressed",t=>{this.heldDirections.indexOf(t)===-1&&this.heldDirections.push(t)});i(this,"onArrowReleased",t=>{const e=this.heldDirections.indexOf(t);e!==-1&&this.heldDirections.splice(e,1)});i(this,"direction",()=>this.heldDirections.length===0?-1:this.heldDirections[this.heldDirections.length-1]);this.heldDirections=new Array,document.addEventListener("keydown",t=>{(t.code==="ArrowUp"||t.code==="KeyW")&&this.onArrowPressed(0),(t.code==="ArrowDown"||t.code==="KeyS")&&this.onArrowPressed(1),(t.code==="ArrowLeft"||t.code==="KeyA")&&this.onArrowPressed(2),(t.code==="ArrowRight"||t.code==="KeyD")&&this.onArrowPressed(3)}),document.addEventListener("keyup",t=>{(t.code==="ArrowUp"||t.code==="KeyW")&&this.onArrowReleased(0),(t.code==="ArrowDown"||t.code==="KeyS")&&this.onArrowReleased(1),(t.code==="ArrowLeft"||t.code==="KeyA")&&this.onArrowReleased(2),(t.code==="ArrowRight"||t.code==="KeyD")&&this.onArrowReleased(3)})}}class z{constructor(){i(this,"resourceList");i(this,"imageList");this.resourceList={sky:"sprites/sky.png",ground:"sprites/ground.png",hero:"sprites/hero-sheet.png",shadow:"sprites/shadow.png",rod:"sprites/rod.png"},this.imageList={},Object.keys(this.resourceList).forEach(t=>{const e=new Image;e.src=this.resourceList[t],this.imageList[t]={image:e,isLoaded:!1},e.onload=()=>{this.imageList[t].isLoaded=!0}})}}const y=new z;class f extends g{constructor(e){super({position:e.position,parent:e.parent});i(this,"resource");i(this,"frameSize");i(this,"hFrames");i(this,"vFrames");i(this,"frame");i(this,"scale");i(this,"frameMap");i(this,"animations");this.resource=e.resource,this.frameSize=e.frameSize??new c(16,16),this.hFrames=e.hFrames??1,this.vFrames=e.vFrames??1,this.frame=e.frame??0,this.scale=e.scale??1,this.frameMap=new Map,this.buildFrameMap(),this.animations=e.animations??null}buildFrameMap(){let e=0;for(let n=0;n<this.vFrames;n++)for(let r=0;r<this.hFrames;r++)this.frameMap.set(e,new c(this.frameSize.x*r,this.frameSize.y*n)),e++}step(e){this.animations&&(this.animations.step(e),this.frame=this.animations.frame())}drawImage(e,n,r){if(!this.resource.isLoaded)return;let a=0,o=0;const h=this.frameMap.get(this.frame);h&&(a=h.x,o=h.y);const m=this.frameSize.x,u=this.frameSize.y;e.drawImage(this.resource.image,a,o,m,u,n,r,m*this.scale,u*this.scale)}}const k=(s=0)=>({duration:400,frames:[{time:0,frame:s+1},{time:100,frame:s},{time:200,frame:s+1},{time:300,frame:s+2}]}),T=(s=0)=>({duration:400,frames:[{time:0,frame:s}]}),M=k(0),X=k(3),Y=k(6),G=k(9),q=T(1),j=T(4),V=T(7),$=T(10),B={duration:400,frames:[{time:0,frame:12}]};class J extends g{constructor(e,n,r){super({position:new c(e,n),parent:r});i(this,"heroFacing");i(this,"destinationPositon");i(this,"body");i(this,"lastX");i(this,"lastY");i(this,"itemPickUpTime");i(this,"itemPickUpShell");i(this,"step",(e,n)=>{if(this.itemPickUpTime>0){this.workOnItemPickUp(e);return}H(this,this.destinationPositon,1)<=1&&this.tryMove(n),this.tryEmitPosition()});i(this,"drawImage",()=>{});i(this,"tryMove",e=>{var m,u,L,S,O,A,x,b;const{input:n,walls:r}=e;if(n.direction()===null||n.direction()===d.ERROR){switch(this.heroFacing){case d.DOWN:{(m=this.body.animations)==null||m.play("standDown");break}case d.UP:{(u=this.body.animations)==null||u.play("standUp");break}case d.LEFT:{(L=this.body.animations)==null||L.play("standLeft");break}case d.RIGHT:{(S=this.body.animations)==null||S.play("standRight");break}}return}let a=this.destinationPositon.x,o=this.destinationPositon.y;const h=16;switch(n.direction()){case d.UP:{o-=h,(O=this.body.animations)==null||O.play("walkUp");break}case d.DOWN:{o+=h,(A=this.body.animations)==null||A.play("walkDown");break}case d.LEFT:{a-=h,(x=this.body.animations)==null||x.play("walkLeft");break}case d.RIGHT:{a+=h,(b=this.body.animations)==null||b.play("walkRight");break}}n.direction()!==d.ERROR&&(this.heroFacing=n.direction()),_(r,a,o)&&(this.destinationPositon.x=a,this.destinationPositon.y=o)});i(this,"tryEmitPosition",()=>{this.lastX===this.position.x&&this.lastY===this.position.y||(this.lastX=this.position.x,this.lastY=this.position.y,w.emit("HERO_POSITION",this.position))});i(this,"workOnItemPickUp",e=>{var n,r;this.itemPickUpTime-=e,(n=this.body.animations)==null||n.play("pickUpDown"),this.itemPickUpTime<=0&&((r=this.itemPickUpShell)==null||r.destroy(),this.itemPickUpShell=null)});i(this,"onPickUpItem",e=>{this.destinationPositon=e.position.duplicate(),this.itemPickUpShell=new C({parent:this}),this.itemPickUpShell.addChild(new f({resource:e.image,position:new c(0,-18),parent:this.itemPickUpShell})),this.addChild(this.itemPickUpShell),this.itemPickUpTime=1500});this.lastX=e,this.lastY=n,this.heroFacing=d.DOWN,this.destinationPositon=this.position.duplicate(),this.itemPickUpTime=0,this.itemPickUpShell=null,this.body=new f({resource:y.imageList.hero,frameSize:new c(32,32),hFrames:3,vFrames:8,frame:2,position:new c(-8,-20),parent:this,animations:new N({walkDown:new p(M),walkUp:new p(Y),walkLeft:new p(G),walkRight:new p(X),standDown:new p(q),standUp:new p(V),standLeft:new p($),standRight:new p(j),pickUpDown:new p(B)})}),this.addChild(this.body);const a=new f({resource:y.imageList.shadow,frameSize:new c(32,32),position:new c(-8,-20),parent:this});this.addChild(a),w.on("HERO_PICKS_UP_ITEM",this,o=>{this.onPickUpItem(o)})}}class Q extends g{constructor(e,n,r){super({position:new c(e,n),parent:r});i(this,"onCollidWithHero",()=>{this.destroy(),w.emit("HERO_PICKS_UP_ITEM",{image:y.imageList.rod,position:this.position})});const a=new f({resource:y.imageList.rod,position:new c(0,-5),parent:this});this.addChild(a),w.on("HERO_POSITION",this,o=>{const h=Math.round(o.x),m=Math.round(o.y);this.position.x===h&&this.position.y===m&&this.onCollidWithHero()})}step(){}drawImage(){}}class Z extends g{constructor(e){super({position:new c(0,0)});i(this,"input");i(this,"walls");this.input=new W,this.walls=e.walls??new Set}step(){}drawImage(){}}const tt=()=>{if(document.querySelector("#game_canvas")===null){console.error("Cannot find game canvas");return}const s=document.querySelector("#game_canvas"),t=s.getContext("2d");if(t===null){console.error("Cannot create canvas context");return}const e=new Z({walls:l}),n=new f({resource:y.imageList.sky,frameSize:new c(I,R),position:new c(0,0)}),r=new f({resource:y.imageList.ground,frameSize:new c(I,R),position:new c(0,0)});e.addChild(r);const a=new J(P(6),P(5),e);e.addChild(a);const o=new D;e.addChild(o);const h=new Q(P(7),P(6),e);e.addChild(h);const m=S=>{e.stepEntry(S,e)},u=()=>{t.clearRect(0,0,s.width,s.height),n.draw(t,0,0),t.save(),t.translate(o.position.x,o.position.y),e.draw(t,0,0),t.restore()};new K(m,u).start()};tt();
