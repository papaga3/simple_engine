var k=Object.defineProperty;var E=(i,t,e)=>t in i?k(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var s=(i,t,e)=>E(i,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=e(n);fetch(n.href,a)}})();const F=8,A=320,R=180;class D{constructor(){s(this,"callbacks",[]);s(this,"nextID",0);s(this,"on",(t,e,r)=>(this.nextID+=1,this.callbacks.push({id:this.nextID,eventName:t,caller:e,callback:r}),this.nextID));s(this,"off",t=>{this.callbacks=this.callbacks.filter(e=>e.id!==t)})}emit(t,e){this.callbacks.forEach(r=>{r.eventName===t&&r.callback(e)})}unsunscribe(t){this.callbacks=this.callbacks.filter(e=>e.caller!==t)}}const P=new D;class c{constructor(t,e){s(this,"x");s(this,"y");s(this,"duplicate",()=>new c(this.x,this.y));this.x=t,this.y=e}}class g{constructor(t){s(this,"position");s(this,"children");s(this,"drawOffSet");s(this,"stepEntry",(t,e)=>{this.children.forEach(r=>r.stepEntry(t,e)),this.step(t,e)});s(this,"draw",(t,e,r)=>{const n=e+this.position.x+this.drawOffSet.x,a=r+this.position.y+this.drawOffSet.y;this.drawImage(t,n,a),this.children.forEach(o=>o.draw(t,n,a))});this.drawOffSet=t.drawOffSet??new c(0,0),this.position=t.position??new c(0,0),this.children=[]}addChild(t){this.children.push(t)}removeChild(t){this.children=this.children.filter(e=>t!==e)}}class C extends g{step(){}drawImage(){}constructor(){super({}),P.on("HERO_POSITION",this,t=>{const e=A/2-F,r=R/2-F;this.position=new c(e-t.x,r-t.y)})}}class K{constructor(t,e){s(this,"lastTimeFrame");s(this,"accumulatedTime");s(this,"timeStep");s(this,"update");s(this,"render");s(this,"rafId");s(this,"isRunning");s(this,"mainLoop",t=>{if(!this.isRunning)return;let e=t-this.lastTimeFrame;this.lastTimeFrame=t,this.accumulatedTime+=e,this.accumulatedTime>=this.timeStep&&(this.update(this.timeStep),this.accumulatedTime=0),this.render(),this.rafId=requestAnimationFrame(this.mainLoop)});s(this,"start",()=>{this.isRunning||(this.isRunning=!0),this.rafId=requestAnimationFrame(this.mainLoop)});s(this,"stop",()=>{this.rafId&&cancelAnimationFrame(this.rafId),this.isRunning=!1});this.lastTimeFrame=0,this.accumulatedTime=0,this.timeStep=1e3/60,this.update=t,this.render=e,this.rafId=null,this.isRunning=!1}}const I=i=>i*16,N=(i,t,e)=>{const r=`${t},${e}`;return!i.has(r)},l=new Set;l.add("64,48");l.add("64,64");l.add("64,80");l.add("80,64");l.add("80,80");l.add("112,80");l.add("128,80");l.add("144,80");l.add("160,80");class z{constructor(t){s(this,"patterns");s(this,"activeKey");s(this,"step",t=>{this.patterns[this.activeKey].step(t)});s(this,"play",(t,e=0)=>{this.activeKey!==t&&(this.activeKey=t,this.patterns[this.activeKey].currentTime=e)});s(this,"frame",()=>this.patterns[this.activeKey].frame());this.patterns=t,this.activeKey=Object.keys(this.patterns)[0]}}class m{constructor(t){s(this,"animationConfig");s(this,"currentTime");s(this,"duration");s(this,"step",t=>{this.currentTime+=t,this.currentTime>=this.duration&&(this.currentTime=0)});s(this,"frame",()=>{const{frames:t}=this.animationConfig;for(let e=t.length-1;e>=0;e--)if(this.currentTime>=t[e].time)return t[e].frame;throw"Time is before the first keyframe"});this.currentTime=0,this.animationConfig=t,this.duration=t.duration??500}}const W=(i,t,e)=>{let r=t.x-i.position.x,n=t.y-i.position.y,a=Math.sqrt(r**2+n**2);if(a<=e)i.position.x=t.x,i.position.y=t.y;else{const o=r/a,h=n/a;i.position.x+=o*e,i.position.y+=h*e,r=t.x-i.position.x,n=t.y-i.position.y,a=Math.sqrt(r**2+n**2)}return a};var d=(i=>(i[i.UP=0]="UP",i[i.DOWN=1]="DOWN",i[i.LEFT=2]="LEFT",i[i.RIGHT=3]="RIGHT",i[i.ERROR=-1]="ERROR",i))(d||{});class H{constructor(){s(this,"heldDirections");s(this,"onArrowPressed",t=>{this.heldDirections.indexOf(t)===-1&&this.heldDirections.push(t)});s(this,"onArrowReleased",t=>{const e=this.heldDirections.indexOf(t);e!==-1&&this.heldDirections.splice(e,1)});s(this,"direction",()=>this.heldDirections.length===0?-1:this.heldDirections[this.heldDirections.length-1]);this.heldDirections=new Array,document.addEventListener("keydown",t=>{(t.code==="ArrowUp"||t.code==="KeyW")&&this.onArrowPressed(0),(t.code==="ArrowDown"||t.code==="KeyS")&&this.onArrowPressed(1),(t.code==="ArrowLeft"||t.code==="KeyA")&&this.onArrowPressed(2),(t.code==="ArrowRight"||t.code==="KeyD")&&this.onArrowPressed(3)}),document.addEventListener("keyup",t=>{(t.code==="ArrowUp"||t.code==="KeyW")&&this.onArrowReleased(0),(t.code==="ArrowDown"||t.code==="KeyS")&&this.onArrowReleased(1),(t.code==="ArrowLeft"||t.code==="KeyA")&&this.onArrowReleased(2),(t.code==="ArrowRight"||t.code==="KeyD")&&this.onArrowReleased(3)})}}class _{constructor(){s(this,"resourceList");s(this,"imageList");this.resourceList={sky:"sprites/sky.png",ground:"sprites/ground.png",hero:"sprites/hero-sheet.png",shadow:"sprites/shadow.png"},this.imageList={},Object.keys(this.resourceList).forEach(t=>{const e=new Image;e.src=this.resourceList[t],this.imageList[t]={image:e,isLoaded:!1},e.onload=()=>{this.imageList[t].isLoaded=!0}})}}const w=new _;class y extends g{constructor(e){super({position:e.position});s(this,"resource");s(this,"frameSize");s(this,"hFrames");s(this,"vFrames");s(this,"frame");s(this,"scale");s(this,"frameMap");s(this,"animations");this.resource=e.resource,this.frameSize=e.frameSize??new c(16,16),this.hFrames=e.hFrames??1,this.vFrames=e.vFrames??1,this.frame=e.frame??0,this.scale=e.scale??1,this.frameMap=new Map,this.buildFrameMap(),this.animations=e.animations??null}buildFrameMap(){let e=0;for(let r=0;r<this.vFrames;r++)for(let n=0;n<this.hFrames;n++)this.frameMap.set(e,new c(this.frameSize.x*n,this.frameSize.y*r)),e++}step(e){this.animations&&(this.animations.step(e),this.frame=this.animations.frame())}drawImage(e,r,n){if(!this.resource.isLoaded)return;let a=0,o=0;const h=this.frameMap.get(this.frame);h&&(a=h.x,o=h.y);const f=this.frameSize.x,u=this.frameSize.y;e.drawImage(this.resource.image,a,o,f,u,r,n,f*this.scale,u*this.scale)}}const S=(i=0)=>({duration:400,frames:[{time:0,frame:i+1},{time:100,frame:i},{time:200,frame:i+1},{time:300,frame:i+2}]}),L=(i=0)=>({duration:400,frames:[{time:0,frame:i}]}),M=S(0),U=S(3),X=S(6),Y=S(9),G=L(1),q=L(4),j=L(7),V=L(10);class $ extends g{constructor(e,r){super({position:new c(e,r)});s(this,"heroFacing");s(this,"destinationPositon");s(this,"body");s(this,"lastX");s(this,"lastY");s(this,"step",(e,r)=>{W(this,this.destinationPositon,1)<=1&&this.tryMove(r),this.tryEmitPosition()});s(this,"drawImage",()=>{});s(this,"tryMove",e=>{var f,u,p,T,b,x,O,v;const{input:r,walls:n}=e;if(r.direction()===null||r.direction()===d.ERROR){switch(this.heroFacing){case d.DOWN:{(f=this.body.animations)==null||f.play("standDown");break}case d.UP:{(u=this.body.animations)==null||u.play("standUp");break}case d.LEFT:{(p=this.body.animations)==null||p.play("standLeft");break}case d.RIGHT:{(T=this.body.animations)==null||T.play("standRight");break}}return}let a=this.destinationPositon.x,o=this.destinationPositon.y;const h=16;switch(r.direction()){case d.UP:{o-=h,(b=this.body.animations)==null||b.play("walkUp");break}case d.DOWN:{o+=h,(x=this.body.animations)==null||x.play("walkDown");break}case d.LEFT:{a-=h,(O=this.body.animations)==null||O.play("walkLeft");break}case d.RIGHT:{a+=h,(v=this.body.animations)==null||v.play("walkRight");break}}r.direction()!==d.ERROR&&(this.heroFacing=r.direction()),N(n,a,o)&&(this.destinationPositon.x=a,this.destinationPositon.y=o)});s(this,"tryEmitPosition",()=>{this.lastX===this.position.x&&this.lastY===this.position.y||(this.lastX=this.position.x,this.lastY=this.position.y,P.emit("HERO_POSITION",this.position))});this.lastX=e,this.lastY=r,this.heroFacing=d.DOWN,this.destinationPositon=this.position.duplicate(),this.body=new y({resource:w.imageList.hero,frameSize:new c(32,32),hFrames:3,vFrames:8,frame:2,position:new c(-8,-20),animations:new z({walkDown:new m(M),walkUp:new m(X),walkLeft:new m(Y),walkRight:new m(U),standDown:new m(G),standUp:new m(j),standLeft:new m(V),standRight:new m(q)})}),this.addChild(this.body);const n=new y({resource:w.imageList.shadow,frameSize:new c(32,32),position:new c(-8,-20)});this.addChild(n)}}class B extends g{constructor(e){super({position:new c(0,0)});s(this,"input");s(this,"walls");this.input=new H,this.walls=e.walls??new Set}step(){}drawImage(){}}const J=()=>{if(document.querySelector("#game_canvas")===null){console.error("Cannot find game canvas");return}const i=document.querySelector("#game_canvas"),t=i.getContext("2d");if(t===null){console.error("Cannot create canvas context");return}const e=new B({walls:l}),r=new y({resource:w.imageList.sky,frameSize:new c(A,R),position:new c(0,0)}),n=new y({resource:w.imageList.ground,frameSize:new c(A,R),position:new c(0,0)});e.addChild(n);const a=new $(I(6),I(5));e.addChild(a);const o=new C;e.addChild(o);const h=p=>{e.stepEntry(p,e)},f=()=>{t.clearRect(0,0,i.width,i.height),r.draw(t,0,0),t.save(),t.translate(o.position.x,o.position.y),e.draw(t,0,0),t.restore()};new K(h,f).start()};J();
